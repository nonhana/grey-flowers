name: Build & Deploy Nuxt to VPS

on:
  push:
    branches: [ master ]

concurrency:
  group: prod-deploy
  cancel-in-progress: false   # 串行部署，避免并发踩环境

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: nuxt-output
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (20.x)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Enable pnpm via corepack
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # 重要：把运行所需内容打包。包含：
      # - .output（Nuxt 产物）
      # - package.json / pnpm-lock.yaml（VPS 装 prod 依赖用）
      # - prisma/（VPS 上执行 migrate 用）
      # - ecosystem.config.cjs（PM2 启动配置）
      - name: Pack artifact
        run: |
          tar -czf output.tar.gz \
            .output \
            package.json \
            pnpm-lock.yaml \
            prisma \
            ecosystem.config.cjs

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuxt-output
          path: output.tar.gz
          retention-days: 3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: nuxt-output

      - name: Copy artifact to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          password: ${{ secrets.VPS_PASSWORD }}
          source: "output.tar.gz"
          target: "${{ secrets.APP_DIR }}"

      - name: SSH deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          script: |
            set -Eeuo pipefail

            cd ${{ secrets.APP_DIR }}

            echo "[1/6] Unpack artifact"
            tar -xzf output.tar.gz

            echo "[2/6] Ensure pnpm on VPS"
            command -v pnpm >/dev/null 2>&1 || (corepack enable && corepack prepare pnpm@latest --activate)

            echo "[3/6] Install production deps"
            pnpm install --frozen-lockfile --prod

            echo "[4/6] Prisma generate (on VPS, uses .env DATABASE_URL)"
            # 这里用 dlx，避免把 prisma CLI 当作 prod 依赖安装
            pnpm dlx prisma generate --schema=prisma/schema.prisma

            echo "[5/6] PM2 reload (zero-downtime)"
            pm2 startOrReload ecosystem.config.js --env production
            pm2 save

            echo "[6/6] Health check"
            curl -fsS http://127.0.0.1:3000/healthz >/dev/null

            echo "✅ Deploy done"
